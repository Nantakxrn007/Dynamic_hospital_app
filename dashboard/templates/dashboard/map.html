<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Platform design ‚Äî Hospital Adequacy</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto; margin: 0; background:#fafafa;}
    .container { max-width: 1200px; margin: 18px auto; padding: 0 12px; }
    h1 { text-align:center; margin: 4px 0 16px; }
    .grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 14px; }
    .card { background: #fff; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.06); padding: 14px; }
    .kpis { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    .kpi { background:#fff; border-radius:10px; padding:12px; text-align:center; box-shadow: inset 0 0 0 1px #eee; }
    .kpi .label { color:#666; font-size:14px; }
    .kpi .value { font-size:24px; font-weight:700; margin-top:4px; }
    #info-box { display:none; margin-top: 10px; }
    .inputs { display:grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .group { border: 1px solid #eee; border-radius: 10px; padding: 10px; }
    .group h4 { margin: 4px 0 10px; }
    .row { display:grid; grid-template-columns: 1fr 90px; gap: 6px; margin-bottom: 6px; }
    .row input { width: 100%; padding:6px 8px; border:1px solid #ddd; border-radius:8px; font-size:13px; text-align:right; }
    .muted { color:#666; font-size: 13px; }
    .actions { display:flex; gap:8px; margin-top: 8px; }
    .btn { padding: 8px 12px; border-radius: 8px; border:none; cursor:pointer; }
    .btn-primary { background:#007bff; color:#fff; }
    .btn-outline { background:#fff; color:#333; border:1px solid #ddd; }
    #map-wrap .title { display:flex; justify-content: space-between; align-items:center; margin-bottom:6px;}
    #map-container { height: 500px; }
    #bar-container { height: 380px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Platform design</h1>
    <div class="grid">
      <div class="card">
        <div class="kpis">
          <div class="kpi">
            <div class="label">(‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</div>
            <div class="value">{{ total_elderly }}</div>
          </div>
          <div class="kpi">
            <div class="label">mean A_i</div>
            <div class="value">{{ mean_Ai }}</div>
          </div>
        </div>
        <div id="map-wrap">
          <div class="title">
            <div class="muted">A</div>
            <button id="reset-btn" class="btn btn-outline">üîÑ Reset</button>
          </div>
          <div id="map-container">{{ map_html|safe }}</div>
        </div>
      </div>
      <div class="card">
        <div class="muted" style="margin-bottom:6px;">Ranking province A_i TOP 10</div>
        <div id="bar-container">{{ bar_html|safe }}</div>
      </div>
    </div>
    <div class="card" id="info-box">
      <div class="muted">B</div>
      <h3 id="prov-title" style="margin:6px 0 4px;"></h3>
      <div id="prov-head" class="muted" style="margin-bottom:8px;"></div>
      <div class="inputs">
        <div class="group" id="grp-x1">
          <h4>X_1 (‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£)</h4>
          <div class="row"><span>‡πÅ‡∏û‡∏ó‡∏¢‡πå</span><input id="doctors_physician" type="number"></div>
          <div class="row"><span>‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå</span><input id="doctors_dentist" type="number"></div>
          <div class="row"><span>‡πÄ‡∏†‡∏™‡∏±‡∏ä</span><input id="doctors_pharmacist" type="number"></div>
          <div class="row"><span>‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</span><input id="doctors_registered_nurse" type="number"></div>
          <div class="row"><span>‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏≤‡∏á</span><input id="doctors_specialist_total" type="number"></div>
        </div>
        <div class="group" id="grp-x2">
          <h4>X_2 (‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå)</h4>
          <div class="row"><span>CT</span><input id="equip_ct_scanner" type="number"></div>
          <div class="row"><span>MRI</span><input id="equip_mri" type="number"></div>
          <div class="row"><span>Lithotripter</span><input id="equip_lithotripter" type="number"></div>
          <div class="row"><span>Ultrasound</span><input id="equip_ultrasound" type="number"></div>
          <div class="row"><span>Dialysis</span><input id="equip_dialysis_machine" type="number"></div>
          <div class="row"><span>Ambulance</span><input id="equip_ambulance" type="number"></div>
          <div class="row"><span>‡πÄ‡∏ï‡∏µ‡∏¢‡∏á</span><input id="equip_bed_total" type="number"></div>
        </div>
        <div class="group" id="grp-x3">
          <h4>X_3 (‡∏™‡∏¥‡∏ó‡∏ò‡∏¥/‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢)</h4>
          <div class="row"><span>UC Scheme</span><input id="insurance_uc_scheme" type="number" step="0.01"></div>
          <div class="row"><span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏£‡∏û.‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢</span><input id="insurance_hospital_count" type="number"></div>
        </div>
        <div class="group" id="grp-x4">
          <h4>X_4 (‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)</h4>
          <div class="row"><span>OPD avg/day</span><input id="opd_avg_outpatients_per_day" type="number" step="0.01"></div>
          <div class="row"><span>IPD avg/day</span><input id="ipd_avg_inpatients_per_day" type="number" step="0.01"></div>
        </div>
      </div>
      <div class="actions">
        <span class="muted">‡πÅ‡∏Å‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î <b>Enter</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà</span>
      </div>
    </div>
  </div>

  <script>
    const boundaries = {{ boundaries|safe }};
    const provinceData = {{ province_data|safe }};
    const normMax = {{ norm_max|safe }};
    const provinceOrder = {{ province_order|safe }};

    const infoBox = document.getElementById('info-box');
    const provTitle = document.getElementById('prov-title');
    const provHead = document.getElementById('prov-head');
    const resetBtn = document.getElementById('reset-btn');

    let lastSelected = null;

    function ready(fn) {
      if (document.readyState !== 'loading') fn();
      else document.addEventListener('DOMContentLoaded', fn);
    }

    ready(function init() {
      const mapDiv = document.querySelector('#map-container .js-plotly-plot');
      const barDiv = document.querySelector('#bar-container .js-plotly-plot');

      function hookWhenReady() {
        if (!mapDiv || !barDiv || !mapDiv.data) {
          requestAnimationFrame(hookWhenReady);
          return;
        }

        const baseIdx = mapDiv.data.findIndex(t => t.name === 'base');
        const hiIdx = mapDiv.data.findIndex(t => t.name === 'highlight');

        // Initialize map with full opacity
        const opacities = provinceOrder.map(() => 1.0);
        Plotly.restyle(mapDiv, { 'marker.opacity': [opacities] }, [baseIdx]);

        // Hover: Highlight province boundary
        mapDiv.on('plotly_hover', function(data) {
          const province = data.points[0].location;
          const coords = boundaries[province];
          if (!coords) return;

          const lats = coords.map(c => c ? c[1] : null);
          const lons = coords.map(c => c ? c[0] : null);
          Plotly.restyle(mapDiv, { lat: [lats], lon: [lons] }, [hiIdx]);
        });

        mapDiv.on('plotly_unhover', function() {
          Plotly.restyle(mapDiv, { lat: [[]], lon: [[]] }, [hiIdx]);
        });

        // Click: Show province details and blur others
        mapDiv.on('plotly_click', function(data) {
          const province = data.points[0].location;
          const info = provinceData[province];
          if (!info) return;

          if (lastSelected === province) {
            resetAll(mapDiv, baseIdx, hiIdx);
            return;
          }
          lastSelected = province;

          provTitle.textContent = `‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ${province}`;
          provHead.textContent = `A_i = ${(+info.A_i).toFixed(3)}  |  ‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ = ${(+info.elderly_population).toLocaleString()} ‡∏Ñ‡∏ô`;
          infoBox.style.display = 'block';

          Object.keys(info).forEach(k => {
            const el = document.getElementById(k);
            if (el) el.value = info[k];
          });

          const opacities = provinceOrder.map(p => (p === province ? 1.0 : 0.2));
          Plotly.restyle(mapDiv, { 'marker.opacity': [opacities] }, [baseIdx]);
        });

        // Reset button
        resetBtn.addEventListener('click', function() {
          resetAll(mapDiv, baseIdx, hiIdx);
        });

        // Enter key to recalculate A_i
        document.addEventListener('keydown', function(ev) {
          if (ev.key !== 'Enter' || !lastSelected) return;

          function gv(id) {
            const el = document.getElementById(id);
            return el ? +el.value : 0;
          }
          const v = {
            doctors_physician: gv('doctors_physician'),
            doctors_dentist: gv('doctors_dentist'),
            doctors_pharmacist: gv('doctors_pharmacist'),
            doctors_registered_nurse: gv('doctors_registered_nurse'),
            doctors_specialist_total: gv('doctors_specialist_total'),
            equip_ct_scanner: gv('equip_ct_scanner'),
            equip_mri: gv('equip_mri'),
            equip_lithotripter: gv('equip_lithotripter'),
            equip_ultrasound: gv('equip_ultrasound'),
            equip_dialysis_machine: gv('equip_dialysis_machine'),
            equip_ambulance: gv('equip_ambulance'),
            equip_bed_total: gv('equip_bed_total'),
            insurance_uc_scheme: gv('insurance_uc_scheme'),
            insurance_hospital_count: gv('insurance_hospital_count'),
            opd_avg_outpatients_per_day: gv('opd_avg_outpatients_per_day'),
            ipd_avg_inpatients_per_day: gv('ipd_avg_inpatients_per_day'),
            elderly_population: gv('elderly_population')
          };

          const staff = v.doctors_physician + v.doctors_dentist + v.doctors_pharmacist +
                        v.doctors_registered_nurse + v.doctors_specialist_total;
          const equip = v.equip_ct_scanner + v.equip_mri + v.equip_lithotripter +
                        v.equip_ultrasound + v.equip_dialysis_machine + v.equip_ambulance +
                        v.equip_bed_total;
          const ins = v.insurance_uc_scheme + v.insurance_hospital_count;
          const svc = (v.opd_avg_outpatients_per_day + v.ipd_avg_inpatients_per_day) / 2.0;

          const X1 = staff / (normMax.staff_max || 1);
          const X2 = equip / (normMax.equip_max || 1);
          const X3 = ins / (normMax.ins_max || 1);
          const X4 = 1 - (svc / (normMax.svc_max || 1));
          const Ai = 0.40 * X1 + 0.30 * X2 + 0.15 * X3 + 0.15 * X4;

          provinceData[lastSelected].A_i = +Ai.toFixed(3);
          provHead.textContent = `A_i = ${Ai.toFixed(3)}  |  ‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ = ${(+v.elderly_population).toLocaleString()} ‡∏Ñ‡∏ô`;

          const zValues = provinceOrder.map(p => provinceData[p].A_i);
          Plotly.update(mapDiv, { z: [zValues] }, {}, [baseIdx]);
          updateBar(zValues);
        });

        function updateBar(zValues) {
          const rows = provinceOrder.map((n, i) => ({ province_name_th: n, A_i: zValues[i] }))
                                    .sort((a, b) => b.A_i - a.A_i).slice(0, 10).reverse();
          Plotly.react(barDiv, [{
            type: 'bar',
            x: rows.map(r => r.A_i),
            y: rows.map(r => r.province_name_th),
            orientation: 'h'
          }], {
            margin: { r: 10, l: 150, t: 40, b: 10 },
            height: 380,
            xaxis: { range: [0, 1] },
            yaxis: { automargin: true, tickfont: { size: 12 }, title: "" }
          });
        }

        function resetAll(mapDiv, baseIdx, hiIdx) {
          const opacities = provinceOrder.map(() => 1.0);
          Plotly.restyle(mapDiv, { 'marker.opacity': [opacities], lat: [[]], lon: [[]] }, [baseIdx, hiIdx]);
          for (let p in provinceData) {
            provinceData[p].A_i = provinceData[p].baseline_A_i;
          }
          const zValues = provinceOrder.map(p => provinceData[p].A_i);
          Plotly.update(mapDiv, { z: [zValues] }, {}, [baseIdx]);
          updateBar(zValues);
          infoBox.style.display = 'none';
          lastSelected = null;
        }
      }
      hookWhenReady();
    });
  </script>
</body>
</html>