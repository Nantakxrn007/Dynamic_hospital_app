<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üè• Adequacy Index Map</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    h2 { text-align: center; margin: 10px 0; }
    #info-box {
      width: 80%;
      margin: 20px auto;
      padding: 15px;
      border-radius: 10px;
      background-color: #f5f5f5;
      display: none; /* üî• ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô */
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #province-name { font-size: 20px; font-weight: bold; color: #007BFF; }
  </style>
</head>
<body>
  <h2>üè• Hospital Adequacy Index Map</h2>
  <!-- üîò ‡∏õ‡∏∏‡πà‡∏° Reset -->
<div style="text-align:center; margin-bottom:10px;">
  <button id="reset-btn"
          style="background-color:#007BFF; color:white; padding:8px 14px; border:none; border-radius:6px; cursor:pointer;">
    üîÑ Reset Map
  </button>
</div>
  <div id="map-container">{{ graph|safe }}</div>

  <!-- üîΩ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î -->
  <div id="info-box">
    <div id="province-name"></div>
    <div id="province-details"></div>
  </div>

    <script>
    const boundaries = {{ boundaries|safe }};
    const provinceData = {{ province_data|safe }};
    const plotDiv = document.querySelector('#map-container').querySelector('div.js-plotly-plot');
    const infoBox = document.getElementById('info-box');
    const provinceName = document.getElementById('province-name');
    const provinceDetails = document.getElementById('province-details');
    const resetBtn = document.getElementById('reset-btn');

    // highlight ‡∏Ç‡∏≠‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover
    plotDiv.on('plotly_hover', function(data) {
      const province = data.points[0].location;
      const coords = boundaries[province];
      if (!coords) return;

      const lats = coords.map(c => c ? c[1] : null);
      const lons = coords.map(c => c ? c[0] : null);

      Plotly.restyle(plotDiv, {
        lat: [lats],
        lon: [lons],
        hoverinfo: 'skip',
        mode: 'lines',
        'line.color': 'black',
        'line.width': 4
      }, [1]);
    });

    plotDiv.on('plotly_unhover', function() {
      Plotly.restyle(plotDiv, { lat: [[]], lon: [[]] }, [1]);
    });

    // üñ±Ô∏è ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
    plotDiv.on('plotly_click', function(data) {
      const province = data.points[0].location;
      const info = provinceData[province];
      if (!info) return;

      // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
      provinceName.textContent = "üìç ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î " + province;
      provinceDetails.innerHTML = `
          <p>üí° Adequacy Index: <b>${info.AdequacyIndex}</b></p>
          <p>üë®‚Äç‚öïÔ∏è Staff Score: ${info.staff_score.toLocaleString()}</p>
          <p>üè• Equipment Score: ${info.equipment_score.toLocaleString()}</p>
          <p>üëµ Elderly Population: ${info.elderly_population.toLocaleString()}</p>
      `;
      infoBox.style.display = "block";

      // ‡πÄ‡∏ö‡∏•‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏≠‡∏∑‡πà‡∏ô
      const allLocations = Object.keys(provinceData);
      const opacities = allLocations.map(p => (p === province ? 1.0 : 0.2));
      Plotly.restyle(plotDiv, { 'marker.opacity': [opacities] }, [0]);
    });

    // üîÑ ‡∏õ‡∏∏‡πà‡∏° Reset
    resetBtn.addEventListener('click', function() {
      const allLocations = Object.keys(provinceData);
      const opacities = allLocations.map(() => 1.0);

      // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ opacity ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
      Plotly.restyle(plotDiv, { 'marker.opacity': [opacities] }, [0]);

      // ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      infoBox.style.display = "none";
    });
  </script>
</body>
</html>
